<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}
.hidden {
  display: none;
}
div.tooltip {    
  background: #lightsteelblue; 
  padding: 0.5em; 
  border-radius: 2px; 
  opacity: 1.0; 
  font: 15px sans-serif;  
  position: absolute;
  pointer-events: none;      
}

#users  {
  width: 800px;
  height: 300px;
  float:left;
  margin-left:0px;
  margin-bottom:0px;
  background-color:#eeeeee;
}
#pages{
  width: 800px;
  height: 400px;
  margin-top:0px;
  margin-bottom:5px;
  background-color:#eeeeee;
  float: left;
  overflow: scroll;
}

</style>
<body>
  <div id = "users"> </div>
  <div id = "pages"> </div>
</body>
<script src="../javascripts/d3.v3.min.js"></script>
<script> 
//zhengjie.miao@192.168.10.9:/var/www/html/wiki/data/meta/_dokuwiki.changes
</script>
<script>

function Exists(list, str) {
  for (var item in list) {
    if (list[item] == str) return item;
  }
  return -1;
}
function parseEmailDate(eDate){
     return d3.time.format("%m/%d/%Y %hh:%mm").parse(eDate);
}



var margin = {top: 30, right: 40, bottom: 30, left: 50},
    width = 750 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom,
    usersHeight = 250, pagesHeight = 500;

var users = new Array();
var pages = new Array();
var xUser = {}, xPage = {};
var selectedUser = {}, selectedPage = {};
var dragging = {};
var changelog1, changelog2;
var remaining = 2;


var xTime = d3.time.scale()
    //.domain([parseEmailDate("01/06/2014 00:00"), parseEmailDate("01/17/2014 23:59")])
    .domain([new Date('2014-10-05'), new Date('2014-10-21')])
    //.domain([new Date, new Date])
    .nice(d3.time.day)
    .range([0, width]);

var yUser = d3.scale.ordinal().rangePoints([usersHeight, 0], 1);
var yPage = d3.scale.ordinal().rangePoints([10, pagesHeight], 1);
var tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip")
    //.classed("hidden", "true");

var color = d3.scale.category20();

var xAxis = d3.svg.axis()
    .scale(xTime)
    .orient("bottom")
    .ticks(d3.time.day)
    .tickFormat(d3.time.format('%d'));

// var yUserAxis = d3.svg.axis()
//     .scale(yUser)
//     .orient("left")
//     .ticks(1);

// var yPageAxis = d3.svg.axis()
//     .scale(yPage)
//     .orient("left");




d3.csv("../javascripts/_dokuwiki.changes.csv", function(error, data1) {
  changelog1 = data1;
  //if (! --remaining) {
    draw();
  //}
});

/*d3.csv("_dokuwiki.changes.csv", function(error, data2) {
  changelog2 = data2;
  if (! --remaining) {
    draw();
  }
});*/

function draw() {
  var userSvg = d3.select("#users").append("svg")
    .attr("width", width + 2*margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  var pageSvg = d3.select("#pages").append("svg")
    .attr("width", width + 2*margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + ",0)");

  var changelog = changelog1;
  changelog1.forEach(function(d) {
    if (Exists(users, d.user) < 0 && d.user.substring(0,4) != "f14_") {
      users.push(d.user);
    }
    if (Exists(pages, d.id) < 0) {
      pages.push(d.id);
    }
  });

  yUser.domain(users);
  users.forEach(function(d) {
    //console.log(d);
    xUser[d] = d3.time.scale()
              .domain(d3.extent(changelog, function(p) {
                return new Date(p["timestamp"]);
              }))
              .range([0, width]);
    selectedUser[d] = 0;
  });
  yPage.domain(pages);
  pages.forEach(function(d) {
    //console.log(d);
    xPage[d] = d3.time.scale()
              .domain(d3.extent(changelog, function(p) {
                return new Date(p["timestamp"]);
              }))
              .range([0, width]);
    selectedPage[d] = 0;
  });
  //yPage.domain([0, users.length+2]);
  var axis = d3.svg.axis().orient("bottom");
  var color = d3.scale.category20();
  var userColor = {};
  users.forEach(function(d, i){
    userColor[d] = color(i);
  });


  
 
  console.log("fan.hong" + Exists(users, "fan.hong"));

 
  userSvg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate("+ margin.left + "," + usersHeight + ")")
      .call(xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", width)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text("Date");

  console.log(yUser(1) + ", "+ yUser(10));

  var userG = userSvg.selectAll(".user")
      .data(users)
      .enter().append("g")
      .attr("class", "user")
      // .attr("id", function(d) {
      //   return d.id;
      // })
      .attr("transform", function(d, i) { 
        return "translate(" + margin.left + "," + (yUser(d)) + ")"; 
      })
      .on("mouseover", function(d, i) {
        var mouse = d3.mouse(userSvg.node()).map( function(d) { return parseInt(d); } );
        var text = "";
        changelog.forEach(function(p) {
          if (p.user == d) {
             
             text += p.id + "<br />";
          }
        });
        tooltip
          //.classed("hidden", false)
          .style("opacity", "1.0")
          .attr("style", "left:"+(mouse[0])+"px;top:"+(mouse[1])+"px")
          .text(function(x) {

            //return text;
          })
          .style("fill", "blue");
      })
      .on("mouseout", function(d, i) {
        
        tooltip
          //.classed("hidden", true);
          .style("opacity", "0.0");
      })
      .call(d3.behavior.drag()
        .origin(function(d) { return {y: yUser(d)}; })
        .on("dragstart", function(d) {
          dragging[d] = yUser(d);
        })
        .on("drag", function(d) {
          dragging[d] = Math.min(usersHeight, Math.max(0, d3.event.y));
          //console.log(d);
          //console.log(dragging[d]);
          users.sort(function(a, b) { return position(b, yUser) - position(a, yUser); });
          //console.log(users);
          yUser.domain(users);
          userG.attr("transform", function(d) { return "translate(" + margin.left + "," + (position(d, yUser)) + ")"; })
        })
        .on("dragend", function(d) {
          delete dragging[d];
          transition(d3.select(this)).attr("transform", "translate(" + margin.left + "," + (yUser(d)) + ")");
        }));

   var pageG = pageSvg.selectAll(".page")
      .data(pages)
      .enter().append("g")
      .attr("class", "page")
      // .attr("id", function(d) {
      //   return d.id;
      // })
      .attr("transform", function(d, i) { 
        return "translate(" + margin.left + "," + (yPage(d)) + ")"; 
      })
      .call(d3.behavior.drag()
        .origin(function(d) { return {y: yPage(d)}; })
        .on("dragstart", function(d) {
          dragging[d] = yPage(d);
        })
        .on("drag", function(d) {
          dragging[d] = Math.min(height, Math.max(0, d3.event.y));
          pages.sort(function(a, b) { return position(a, yPage) - position(b, yPage); });
          yPage.domain(pages);
          pageG.attr("transform", function(d) { return "translate(" + margin.left + "," + position(d, yPage) + ")"; })
        })
        .on("dragend", function(d) {
          delete dragging[d];
          transition(d3.select(this)).attr("transform", "translate(" + margin.left + "," + yPage(d) + ")");
        }));


  // Add an axis and title.

  userG.append("g")
      .attr("class", "axis")
      .each(function(d) { d3.select(this).call(axis.scale(xUser[d])); })
      //.on("click", click)
      .style("stroke-dasharray", ("2,4"))
    .append("text")
      .style("text-anchor", "end")
      .text(function(d) { return d; })
      .attr("fill", "#000")
      .on("mouseover", function(d) {

        var text = "";
        changelog.forEach(function(p) {
          if (p.user == d) {
            pageSvg.selectAll("#page" + p.timestamp)//.style("stroke-width", "2.0px"); 
              .style("opacity","1.0");
             text += p.id + "<br />";
          }
        })
      })
      .on("mouseout", function(d) {
        changelog.forEach(function(p) {
          pageSvg.selectAll("#page" + p.timestamp)
                          .style("opacity","0.5"); 
        });
      })
      .on("click", function(d){
        //console.log(d);
        if (selectedUser[d] == 0) {
          selectedUser[d] = 1;
          selectedPage = {};
          d3.select(this).style("fill", userColor[d]);
          //console.log(selectedPage);
          changelog.forEach(function(p) {
            if (selectedUser[p.user] == 1) {
              if (selectedPage[p.id] == null) selectedPage[p.id] = 1;
                else selectedPage[p.id] += 1;
              pageSvg.select("#page" + p.timestamp).style("fill", userColor[p.user]);
            }
          });
          
          pages.sort(function(a, b) { 
            if (selectedPage[a] == null && selectedPage[b] == null) return position(a, yPage) - position(b, yPage); 
              else 
                if (selectedPage[a] == null) return 1;
                  else if (selectedPage[b] == null) return -1;
                    else if (selectedPage[a] == selectedPage[b]) return position(a, yPage) - position(b, yPage); 
                      else return selectedPage[b] - selectedPage[a];
          });
          //console.log(selectedPage);

          yPage.domain(pages);
          pageG.attr("transform", function(d) { return "translate(" + margin.left + "," + position(d, yPage) + ")"; })
            .transition().duration(1000);
        }
        else {
          selectedUser[d] = 0;
          selectedPage = {};
          d3.select(this).style("fill", "#000");
          changelog.forEach(function(p) {
            pageSvg.select("#page" + p.timestamp).style("fill", "white");
            if (selectedUser[p.user] == 1) {
              if (selectedPage[p.id] == null) selectedPage[p.id] = 1;
                else selectedPage[p.id] += 1;
              pageSvg.select("#page" + p.timestamp).style("fill", userColor[p.user]);
            }
          })
          
          pages.sort(function(a, b) { 
            if (selectedPage[a] == null && selectedPage[b] == null) return position(a, yPage) - position(b, yPage); 
              else 
                if (selectedPage[a] == null) return 1;
                  else if (selectedPage[b] == null) return -1;
                     else if (selectedPage[a] == selectedPage[b]) return position(a, yPage) - position(b, yPage); 
                      else return selectedPage[b] - selectedPage[a];
          });
          //console.log(selectedPage);

          yPage.domain(pages);
          pageG.attr("transform", function(d) { return "translate(" + margin.left + "," + (position(d, yPage)) + ")"; })
            .transition().duration(500);

        }
      });

  userG.selectAll("path.user")
    .data(function(d) {
        //console.log(d);
        if (d == "siming.chen") console.log(changelog.filter(function(p){ return p.user == d;}));
        return changelog.filter(function(p){ return p.user == d;});
      })
      .enter()
      .append("path")
      .attr("transform", function(d) { 
        return "translate(" + xTime(d.timestamp*1000) + "," + 0 + ")"; 
      })
      .attr("class", "user")
      .attr("d", d3.svg.symbol()
                  .size(function(d) { return 50; })
                  .type(function(d) { 
                    if (d.user == "siming.chen")
                      console.log(d);
                    switch (d.type) {
                      case "C":return d3.svg.symbolTypes[3]; 
                      case "D":return d3.svg.symbolTypes[2]; 
                      case "E":return d3.svg.symbolTypes[0]; 
                    }
                  })
      )
      .style("fill", "steelblue")
      .style("stroke", "black")
      .style("stroke-width", "0px")
      .on("mouseover", function(d, i) {
        var mouse = d3.mouse(userSvg.node()).map( function(d) { return parseInt(d); } );
        console.log(mouse[0] + ","+mouse[1]);
        tooltip
          //.classed("hidden", false)
          .style("opacity", "1.0")
          .attr("style", "left:"+(mouse[0])+"px;top:"+(mouse[1])+"px")
          .text(function(x) {return d.id + ", " + d.type + ", " + d.user; 
          })
          .style("fill", "blue");


        pageSvg.selectAll("#page" + d.timestamp)
                          .style("opacity","1.0"); 
      })
      .on("mouseout", function(d, i) {

        pageSvg.selectAll("#page" + d.timestamp)
                          .style("opacity","0.5"); 
        tooltip
          //.classed("hidden", true);
          .style("opacity", "0.0");
      });

 


  // Add an axis and title.

  pageG.append("g")
      .attr("class", "axis")
      .each(function(d) { d3.select(this).call(axis.scale(xPage[d])); })
      .style("stroke-dasharray", ("2,4"))
      //.on("click", click)
      .attr("fill",  function (d, i) {
        //if (selectedAttr[i+1] == 1) return "red";
        //  else return "#000";
        return "#000";
      })
    .append("text")
      .style("text-anchor", "end")
      .text(function(d) { return d; });

  pageG.selectAll("path.page")
    .data(function(d) {
        return changelog.filter(function(p){ return p.id == d;});
      })
      .enter()
      .append("path")
      .attr("id", function(d){
        return "page"+d.timestamp;
      })
      .attr("transform", function(d) { 
         if (d.id == "visgroup:projects:prefetching") console.log(d+"," + xTime(d.timestamp*1000) );
        return "translate(" + xTime(d.timestamp*1000) + "," + 0 + ")"; 
      })
      .attr("class","page")
      .attr("d", d3.svg.symbol()
                  .size(function(d) { return 50; })
                  .type(function(d) { 

                  if (d.id == "visgroup:projects:spatial_temporal_event_vis:weibogeo:version2:start") console.log(d);
                  if (d.id == "visgroup:projects:prefetching") console.log(d);
                    switch (d.type) {
                      case "C":return d3.svg.symbolTypes[3]; 
                      case "D":return d3.svg.symbolTypes[2]; 
                      case "E":return d3.svg.symbolTypes[0]; 
                    }
                  })
      )
      .style("fill", "white")
      .style("stroke", "black")
      .style("stroke-width", "1px")
      .style("opacity", "0.5")
      .on("mouseover", function(d, i) {
        var mouse = d3.mouse(pageSvg.node()).map( function(d) { return parseInt(d); } );
        console.log(mouse[0] + ","+mouse[1]);
        tooltip
          //.classed("hidden", false)
          .style("opacity", "1.0")
          .attr("style", "left:"+(mouse[0])+"px;top:"+(mouse[1]+usersHeight)+"px")
          .text(function(x) {return d.id + ", " + d.type + ", " + d.user; 
          })
          .style("fill", "blue");
      })
      .on("mouseout", function(d, i) {
        tooltip
          //.classed("hidden", true);
          .style("opacity", "0.0");
      });




  // var legend = svg.selectAll(".legend")
  //     .data(color.domain())
  //   .enter().append("g")
  //     .attr("class", "legend")
  //     .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  // legend.append("rect")
  //     .attr("x", width + 18)
  //     .attr("width", 18)
  //     .attr("height", 18)
  //     .style("fill", color);

  // legend.append("text")
  //     .attr("x", width + 12)
  //     .attr("y", 9)
  //     .attr("dy", ".35em")
  //     .style("text-anchor", "end")
  //     .text(function(d) { return d; });
}


function position(d, y) {
  var v = dragging[d];
  return v == null ? y(d) : v;
}

function transition(g) {
  return g.transition().duration(500);
}


</script>